{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/2019-10-16--使用阿里云OSS+Docker搭建Nextcloud/","result":{"data":{"site":{"siteMetadata":{"disqus":"sorayama"}},"post":{"html":"<h2 id=\"前言\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>之前一直都是用的 <a href=\"https://owncloud.org/\">owncloud</a> 来管理和同步一些自己的资料, 搭建在自己屋子里的服务器上.\n然而最近需要上传和下载东西的时候发现由于受制于住的地方以及转发服务器的性能和带宽网速十分捉急.\n之前随便转悠的时候发现了比 owncloud 更佳的替代和解决方案, 即 <a href=\"https://nextcloud.com/\">nextcloud</a>.\n刚巧之前想随便玩玩 OSS, 结合<a href=\"https://qianrong.me/website/15.html\">这篇</a>文章有了自己搭建一个 <code class=\"language-text\">Nextcloud</code> + <code class=\"language-text\">aliyun OSS</code> 做的想法.</p>\n<blockquote>\n<p>Nextcloud 是 Owncloud 的一个分支，原美国的 Owncloud 公司已倒闭由德国公司接手更新，其原创始人出走创立了 Nextcloud，由测试来看， 两者客户端是互通的，界面几乎一样，但 Nextcloud 使用更加灵活，比如可以自定义 Logo 和主题，功能更加强大，推荐用 Nextcloud</p>\n</blockquote>\n<h2 id=\"oss\"><a href=\"#oss\" aria-label=\"oss permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OSS</h2>\n<p>OSS 即对象存储, 之前本来打算是拿来做图床, 然而发现根本没什么可放的(). 具体的购买和选购大概对比了下七牛云和阿里云的 OSS 发现如果存的东西比较多价格差别不是很大, 然而如果存的很少七牛有 40G 的免费存储量可以自己玩.\n然而这里是因为刚好用阿里的 ECS 就刚好用他家 OSS 来做搭建了</p>\n<h3 id=\"ossfs\"><a href=\"#ossfs\" aria-label=\"ossfs permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ossfs</h3>\n<p>由于要连接 oss 和 ECS 实例, 挂载阿里云的 oss 映射到服务器上, 需要下载阿里自己搞的一个包 (<a href=\"https://github.com/aliyun/ossfs\">GitHub Repo</a>), 根据<a href=\"https://github.com/aliyun/ossfs/blob/master/README-CN.md\">官方 README</a>安装就行, 以下对 Ubuntu 18.04 做一个示例</p>\n<ol>\n<li>下载安装</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 这里版本选择较新的符合自己系统的版本</span>\n<span class=\"token builtin class-name\">cd</span> ~\n\n<span class=\"token function\">wget</span> https://github.com/aliyun/ossfs/releases/download/v1.80.5/ossfs_1.80.5_ubuntu16.04_amd64.deb\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> gdebi-core\n\n<span class=\"token function\">sudo</span> gdebi ./ossfs_1.80.5_ubuntu16.04_amd64.deb</code></pre></div>\n<ol start=\"2\">\n<li>设置 ossfs 信息</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /etc\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> passwd-ossfs <span class=\"token comment\"># 这里写入一行自己的oss信息, 格式为 &lt;bucket名字>:&lt;access-key-id(在阿里云控制台Accesskey找和创建)>:&lt;access-key-secret></span>\n\n<span class=\"token comment\"># 注意这里权限如果不用默认路径需要改成 600</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> <span class=\"token number\">640</span> /etc/passwd-ossfs\n\n<span class=\"token comment\"># 创建自己的挂载文件目录</span>\n<span class=\"token builtin class-name\">cd</span> /tmp <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mkdir</span> ossfs</code></pre></div>\n<ol start=\"3\">\n<li>编写挂载脚本</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> ~/\n\n<span class=\"token comment\"># 这里加权限为了后面步骤</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> start_ossfs.sh</code></pre></div>\n<p>然后写入</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 卸载</span>\nfusermount -u /tmp/ossfs\n\n<span class=\"token comment\"># 重新挂载 (这里需要前台运行 -f, 指定id是为了docker, 掩码是和 allow_other是为了控制挂载盘的docker进程访问权限)</span>\n<span class=\"token builtin class-name\">exec</span> ossfs my-bucket <span class=\"token punctuation\">\\</span>\n  my-mount-point <span class=\"token punctuation\">\\</span>\n  -ourl<span class=\"token operator\">=</span>my-oss-endpoint <span class=\"token punctuation\">\\</span>\n  -f -ouid<span class=\"token operator\">=</span><span class=\"token number\">33</span> -ogid<span class=\"token operator\">=</span><span class=\"token number\">0</span> -o allow_other -o <span class=\"token assign-left variable\">mp_umask</span><span class=\"token operator\">=</span>007</code></pre></div>\n<ol start=\"4\">\n<li>配置 supervisor</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 安装</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> supervisor</code></pre></div>\n<p>编辑 <code class=\"language-text\">/etc/supervisor/supervisord.conf</code> (也可以单独写一个加到 <code class=\"language-text\">conf.d</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">[program:ossfs]\ncommand=bash /YOUR/PATH/TO/SCRIPT/start_ossfs.sh\nlogfile=/var/log/ossfs.log\nlog_stdout=true\nlog_stderr=true\nlogfile_maxbytes=1MB\nlogfile_backups=10</code></pre></div>\n<ol start=\"5\">\n<li>运行</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> supervisord -c /etc/supervisor/supervisord.conf</code></pre></div>\n<ol start=\"6\">\n<li>确认一切 OK</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> supervisor <span class=\"token comment\"># 应该能看到supervisor进程</span>\n<span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ossfs <span class=\"token comment\"># 应该能看到ossfs进程</span>\n<span class=\"token function\">kill</span> -9 ossfs <span class=\"token comment\"># 杀掉ossfs进程，supervisor应该会重启它, 不要使用killall, 因为killall发送SIGTERM，进程正常退出，supervisor不再去重新运行ossfs</span>\n<span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ossfs <span class=\"token comment\"># 应该能看到ossfs进程</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">df</span> -h <span class=\"token comment\"># 应该能看到 ossfs 正确挂载</span></code></pre></div>\n<p>注意如果 <code class=\"language-text\">ossfs</code> 没有启动需要杀掉 <code class=\"language-text\">supervisor</code> 进程重新启动</p>\n<h2 id=\"https\"><a href=\"#https\" aria-label=\"https permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>https</h2>\n<h3 id=\"证书\"><a href=\"#%E8%AF%81%E4%B9%A6\" aria-label=\"证书 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>证书</h3>\n<p>如果已经有证书的可以略过, 此处是用 <code class=\"language-text\">letsencrypt</code> 来生成证书</p>\n<h3 id=\"开始\"><a href=\"#%E5%BC%80%E5%A7%8B\" aria-label=\"开始 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>开始</h3>\n<p>下面的步骤分为两种, 第一种是来自官网教程, 用 <code class=\"language-text\">nginx</code> 做容器直接跑一个 <code class=\"language-text\">nextcloud</code>, 并且内置了 <code class=\"language-text\">letsencrypt</code> 套件, <strong>听起来</strong>十分方便. 第二种是我自己用的比较一般的采用机器上跑 <code class=\"language-text\">nginx</code> 做反代的方式.</p>\n<p>这里因为自己使用的是第二种, 先说第二种</p>\n<h3 id=\"下载-nginx-和-certbot\"><a href=\"#%E4%B8%8B%E8%BD%BD-nginx-%E5%92%8C-certbot\" aria-label=\"下载 nginx 和 certbot permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>下载 Nginx 和 Certbot</h3>\n<blockquote>\n<p><a href=\"https://certbot.eff.org\">Certbot 官网</a></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> nginx</code></pre></div>\n<p><a href=\"https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx\">安装 <code class=\"language-text\">Certbot</code></a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> software-properties-common\n<span class=\"token function\">sudo</span> add-apt-repository universe\n<span class=\"token function\">sudo</span> add-apt-repository ppa:certbot/certbot\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> certbot python-certbot-nginx</code></pre></div>\n<h3 id=\"编辑-conf\"><a href=\"#%E7%BC%96%E8%BE%91-conf\" aria-label=\"编辑 conf permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>编辑 conf</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/nginx/sites-available/nextcloud.YOUR_DOMAIN.com.conf</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">listen</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span> ipv6only<span class=\"token operator\">=</span>on<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">server_name</span> nextcloud<span class=\"token punctuation\">.</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">root</span> <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>www<span class=\"token operator\">/</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">index</span> <span class=\"token keyword\">index</span><span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try_files</span> <span class=\"token variable\">$uri</span> <span class=\"token variable\">$uri</span><span class=\"token operator\">/</span> <span class=\"token operator\">=</span><span class=\"token number\">404</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>编辑好以后可以重启下 <code class=\"language-text\">nginx</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s /etc/nginx/sites-available/nextcloud.YOUR_DOMAIN.com.conf /etc/nginx/sites-enabled/nextcloud.YOUR_DOMAIN.com.conf\n<span class=\"token function\">sudo</span> nginx -t <span class=\"token comment\"># 测试配置</span>\n<span class=\"token function\">sudo</span> systemctl stop nginx\n<span class=\"token function\">sudo</span> systemctl start nginx\n<span class=\"token function\">sudo</span> systemctl status nginx <span class=\"token comment\"># 应该是 running 状态</span></code></pre></div>\n<h3 id=\"配置证书\"><a href=\"#%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6\" aria-label=\"配置证书 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配置证书</h3>\n<p>这一步用 <code class=\"language-text\">Certbot</code> 会比较简单, 命令如下</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> certbot --rsa-key-size <span class=\"token number\">4096</span> --nginx</code></pre></div>\n<p>配置好以后可以看下配置文件, 这里贴下自用的:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">server_name</span> nextcloud<span class=\"token punctuation\">.</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">root</span> <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>www<span class=\"token operator\">/</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">index</span> <span class=\"token keyword\">index</span><span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span><span class=\"token operator\">/</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Real<span class=\"token operator\">-</span>IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>Proto <span class=\"token variable\">$scheme</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">add_header</span> Strict<span class=\"token operator\">-</span>Transport<span class=\"token operator\">-</span>Security <span class=\"token string\">\"max-age=31536000; includeSubDomains; preload\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">client_max_body_size</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">access_log</span> <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>log<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>nextcloud<span class=\"token punctuation\">.</span>access<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">error_log</span> <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>log<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>nextcloud<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">443</span> <span class=\"token keyword\">ssl</span> ipv6only<span class=\"token operator\">=</span>on<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    <span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> <span class=\"token keyword\">ssl</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    <span class=\"token keyword\">ssl_certificate</span> <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>letsencrypt<span class=\"token operator\">/</span>live<span class=\"token operator\">/</span>nextcloud<span class=\"token punctuation\">.</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>fullchain<span class=\"token punctuation\">.</span>pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    <span class=\"token keyword\">ssl_certificate_key</span> <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>letsencrypt<span class=\"token operator\">/</span>live<span class=\"token operator\">/</span>nextcloud<span class=\"token punctuation\">.</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>privkey<span class=\"token punctuation\">.</span>pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    <span class=\"token keyword\">include</span> <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>letsencrypt<span class=\"token operator\">/</span>options<span class=\"token operator\">-</span><span class=\"token keyword\">ssl</span><span class=\"token operator\">-</span>nginx<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    <span class=\"token keyword\">ssl_dhparam</span> <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>letsencrypt<span class=\"token operator\">/</span><span class=\"token keyword\">ssl</span><span class=\"token operator\">-</span>dhparams<span class=\"token punctuation\">.</span>pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$host</span> <span class=\"token operator\">=</span> nextcloud<span class=\"token punctuation\">.</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">301</span> <span class=\"token keyword\">https</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token variable\">$host</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token comment\"># managed by Certbot</span>\n\n\n    <span class=\"token keyword\">listen</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span> ipv6only<span class=\"token operator\">=</span>on<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">server_name</span> nextcloud<span class=\"token punctuation\">.</span>YOUR_DOMAIN<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">error_page</span> <span class=\"token number\">497</span>  <span class=\"token keyword\">https</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token variable\">$host</span><span class=\"token variable\">$uri</span><span class=\"token operator\">?</span><span class=\"token variable\">$args</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">404</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>以上文件中部分都是 <code class=\"language-text\">Certbot</code> 自动生成</p>\n<h3 id=\"nextcloud-image\"><a href=\"#nextcloud-image\" aria-label=\"nextcloud image permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nextcloud image</h3>\n<p>说回刚才的第一种方式, 由于没有亲自试过所以不好评价, 总之看说明会比自己配置反代要轻松一些并且可能会少走一些坑, 但与此同时 <code class=\"language-text\">nextcloud</code> 的镜像也得改, 因此以下部分不适用于这个方式. 感兴趣的话可以自己试试</p>\n<p><a href=\"https://github.com/nextcloud/docker/tree/master/.examples#with-nginx-proxy\">戳这里获取例子</a></p>\n<h3 id=\"nextcloud\"><a href=\"#nextcloud\" aria-label=\"nextcloud permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nextcloud</h3>\n<p>由于这里是采用 <code class=\"language-text\">Docker</code> 进行容器化部署, 就直接贴配置和文件了, <code class=\"language-text\">Docker</code> 的安装和使用不在此赘述.</p>\n<ol>\n<li>建立 <code class=\"language-text\">Docker</code> 的目录</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> ~ <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mkdir</span> compose\n\n<span class=\"token builtin class-name\">cd</span> compose <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mkdir</span> nextcloud <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> nextcloud</code></pre></div>\n<ol start=\"2\">\n<li>依次添加以下文件</li>\n<li><code class=\"language-text\">db.env</code></li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"env\"><pre class=\"language-env\"><code class=\"language-env\">MYSQL_PASSWORD=YOUR_PASSWORD\nMYSQL_DATABASE=nextcloud\nMYSQL_USER=nextcloud</code></pre></div>\n<ul>\n<li><code class=\"language-text\">docker-compose.yml</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mariadb\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>transaction<span class=\"token punctuation\">-</span>isolation=READ<span class=\"token punctuation\">-</span>COMMITTED <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>binlog<span class=\"token punctuation\">-</span>format=ROW\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db<span class=\"token punctuation\">:</span>/var/lib/mysql\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> MYSQL_ROOT_PASSWORD=YOUR_MYSQL_PASSWORD\n    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db.env\n\n  <span class=\"token key atrule\">redis</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> redis\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./app\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 8080<span class=\"token punctuation\">:</span><span class=\"token number\">80</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> nextcloud<span class=\"token punctuation\">:</span>/var/www/html\n      <span class=\"token punctuation\">-</span> ./custom_apps<span class=\"token punctuation\">:</span>/var/www/html/custom_apps\n      <span class=\"token punctuation\">-</span> /tmp/ossfs<span class=\"token punctuation\">:</span>/var/www/html/data\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> MYSQL_HOST=db\n      <span class=\"token punctuation\">-</span> NEXTCLOUD_ADMIN_UESR=YOUR_ADMIN\n      <span class=\"token punctuation\">-</span> NEXTCLOUD_ADMIN_PASSWORD=YOUR_PASSWORD\n      <span class=\"token punctuation\">-</span> NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.YOUR_DOMAIN.com <span class=\"token comment\"># 注意这里可以用空格分开添加多个可信域名</span>\n      <span class=\"token punctuation\">-</span> NEXTCLOUD_OVERWRITEPROTOCOL=https\n    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db.env\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n      <span class=\"token punctuation\">-</span> redis\n\n  <span class=\"token key atrule\">cron</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./app\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> nextcloud<span class=\"token punctuation\">:</span>/var/www/html\n      <span class=\"token punctuation\">-</span> ./custom_apps<span class=\"token punctuation\">:</span>/var/www/html/custom_apps\n      <span class=\"token punctuation\">-</span> /tmp/ossfs<span class=\"token punctuation\">:</span>/var/www/html/data\n    <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> /cron.sh\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n      <span class=\"token punctuation\">-</span> redis\n\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n  nextcloud<span class=\"token punctuation\">:</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">Makefile</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\"><span class=\"token symbol\">down</span><span class=\"token punctuation\">:</span>\n\tdocker-compose down\n\n<span class=\"token symbol\">up</span><span class=\"token punctuation\">:</span>\n\tdocker-compose up -d\n\n<span class=\"token symbol\">start</span><span class=\"token punctuation\">:</span> down up</code></pre></div>\n<ul>\n<li><code class=\"language-text\">./app/Dockerfile</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> nextcloud<span class=\"token punctuation\">:</span>apache\n\n<span class=\"token keyword\">COPY</span> redis.config.php /usr/src/nextcloud/config/redis.config.php</code></pre></div>\n<ul>\n<li><code class=\"language-text\">./app/redis.config.php</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$CONFIG</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token single-quoted-string string\">'memcache.locking'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'\\OC\\Memcache\\Redis'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token single-quoted-string string\">'redis'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n    <span class=\"token single-quoted-string string\">'host'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'redis'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'port'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">custom_app</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> custom_app\n\n<span class=\"token comment\"># 在改变权限之后如果要安装App的话就得用root权限了</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> -R www-data:root ./custom_app</code></pre></div>\n<blockquote>\n<p>注意这里可以自己从<a href=\"https://apps.nextcloud.com/\">nextcloud 应用商店</a>来下载自定义 App 来安装解压放到这个目录下, 比如 talk 就不再是默认提供的 App 了 (由于文档比较老让直接到相关页面找害得找了半天)</p>\n</blockquote>\n<ol start=\"3\">\n<li>运行</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">make</span> start</code></pre></div>\n<p>成功的话应该可以访问到服务期地址 <code class=\"language-text\">8080</code> 端口看到正确的登录画面</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 690px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fce953fd8102c31805326e4359da711f/d739b/login.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.19289340101524%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIEA//EABcBAAMBAAAAAAAAAAAAAAAAAAABBAL/2gAMAwEAAhADEAAAAeWjLVkABNjQLX//xAAZEAACAwEAAAAAAAAAAAAAAAABAgMSICH/2gAIAQEAAQUCHS8VV3//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwEhP//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABgQAAIDAAAAAAAAAAAAAAAAAAARITCR/9oACAEBAAY/AkONo//EABsQAAIBBQAAAAAAAAAAAAAAAAERABAgIVGx/9oACAEBAAE/IQWCD3MQ63Gn/9oADAMBAAIAAwAAABAL+EL/xAAWEQEBAQAAAAAAAAAAAAAAAAABESD/2gAIAQMBAT8QRETD/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EEdMYz//xAAcEAEAAgIDAQAAAAAAAAAAAAABABEhMRBBcYH/2gAIAQEAAT8QdojoVQQgYA0gE/KgFQ3DrGscGz2ADEJ//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"login\"\n        title=\"login\"\n        src=\"/static/fce953fd8102c31805326e4359da711f/8c996/login.jpg\"\n        srcset=\"/static/fce953fd8102c31805326e4359da711f/6f483/login.jpg 173w,\n/static/fce953fd8102c31805326e4359da711f/0fa0d/login.jpg 345w,\n/static/fce953fd8102c31805326e4359da711f/8c996/login.jpg 690w,\n/static/fce953fd8102c31805326e4359da711f/c8cd5/login.jpg 1035w,\n/static/fce953fd8102c31805326e4359da711f/00650/login.jpg 1380w,\n/static/fce953fd8102c31805326e4359da711f/d739b/login.jpg 1576w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"踩坑记\"><a href=\"#%E8%B8%A9%E5%9D%91%E8%AE%B0\" aria-label=\"踩坑记 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>踩坑记</h3>\n<ol>\n<li>由于阿里云安全组设置里 443 端口没开导致一度怀疑人生</li>\n<li>因为我域名备案过很久才下来, 所以是在镜像跑起来之后才配置 https 相关. 在配置好之后一直提示域名不在可信任域名里, 一通搜索发现需要在 <code class=\"language-text\">docker-compose</code> 里加 <code class=\"language-text\">NEXTCLOUD_TRUSTED_DOMAINS</code> 这个环境变量.\n然而我加上之后 <code class=\"language-text\">down</code> 掉重新 <code class=\"language-text\">up</code> 还是不行. 进到 <code class=\"language-text\">container</code> 里看发现并不起作用. 本来想要把 volume 卸载重新来一遍, 结果大神直接把官方 repo 里加信任域名的那<a href=\"https://github.com/nextcloud/docker/blob/master/17.0/apache/entrypoint.sh#L119-L127\">一段代码</a>\n给摘下来运行了下结果 OK 了, 等于写回了挂载的 nextcloud 卷里(顺带一提这个位置在 <code class=\"language-text\">/var/lib/docker/volumes/nextcloud_nextcloud</code>)</li>\n<li>后来发现配置的 https 总会在浏览器报错, 因为<code class=\"language-text\">nextcloud server</code>端还是用的 http, 只有将 <code class=\"language-text\">overwriteprotocol =&gt; https</code> 写到 <code class=\"language-text\">config.php</code> 里才行. 但还是这一步得初始化做, 所以还是像第二步一样直接写到卷里挂进去就好.</li>\n</ol>\n<h2 id=\"小结\"><a href=\"#%E5%B0%8F%E7%BB%93\" aria-label=\"小结 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>小结</h2>\n<ul>\n<li>上传下载速度有明显提升, 理论讲速度和带宽应该差不多一致</li>\n<li>UI 和功能完整度以及安全性方面比 <code class=\"language-text\">owncloud</code> 有一些提升, 值得一搞</li>\n<li>发现新的 UI 是拿 <code class=\"language-text\">Vue</code> 写的</li>\n<li>首次登入输入完管理员账号之后出现连不上数据库的报错虽然比较莫名其妙但是多登入一次就行</li>\n<li>要注意加载卷的权限, 这里挂载脚本设置权限是一个坑</li>\n</ul>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://medium.com/@Alibaba_Cloud/how-to-install-nextcloud-talk-using-docker-on-alibaba-cloud-ffc8fb326405\">how-to-install-nextcloud-talk-using-docker-on-alibaba-cloud</a></li>\n<li><a href=\"https://blog.ssdnodes.com/blog/installing-nextcloud-docker/\">installing-nextcloud-docker</a></li>\n<li><a href=\"https://www.cnblogs.com/woshimrf/p/understand-docker-uid.html?spm=a2c4e.10696291.0.0.ad0a19a4PZkqWV\">understand-docker-uid</a></li>\n<li><a href=\"https://yq.aliyun.com/articles/53990\">谈谈 Docker Volume 之权限管理</a></li>\n</ul>","excerpt":"前言 之前一直都是用的 owncloud 来管理和同步一些自己的资料, 搭建在自己屋子里的服务器上.\n然而最近需要上传和下载东西的时候发现由于受制于住的地方以及转发服务器的性能和带宽网速十分捉急.\n之前随便转悠的时候发现了比 owncloud…","timeToRead":12,"fields":{"slug":"/blog/2019-10-16--使用阿里云OSS+Docker搭建Nextcloud/"},"frontmatter":{"tags":["2019-10","Docker","nextcloud"],"author":{"id":"SoraYama - 空山","bio":"折腾点前端和其他","twitter":"@ClassicSilence1","avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/d7657fc7ec759cfa220ac058ed0b571a/7ca4f/avatar.jpg","srcSet":"/static/d7657fc7ec759cfa220ac058ed0b571a/7ca4f/avatar.jpg 1x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/236eb/avatar.jpg 1.5x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/30e6d/avatar.jpg 2x"}}]}},"title":"使用阿里云OSS+Docker搭建Nextcloud","updatedDate":"Nov 6, 2019","image":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/1bb99f288b731ba8e714fc91933b88eb/bb67a/nextcloud.jpg","srcSet":"/static/1bb99f288b731ba8e714fc91933b88eb/bb67a/nextcloud.jpg 1x"}}]}}},"recents":{"edges":[{"node":{"fields":{"slug":"/blog/2020-08-12-pixel3用charles抓包以及root/"},"timeToRead":6,"frontmatter":{"title":"Pixel 3 charles 抓包以及 root 记录","updatedDate":"2020-08-12","image":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/f9b54ac624d823fa3d1a87da629f034b/37089/pixel3.jpg","srcSet":"/static/f9b54ac624d823fa3d1a87da629f034b/37089/pixel3.jpg 1x,\n/static/f9b54ac624d823fa3d1a87da629f034b/4a855/pixel3.jpg 1.5x,\n/static/f9b54ac624d823fa3d1a87da629f034b/92aae/pixel3.jpg 2x"}}]},"author":{"avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg","srcSet":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg 1x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/1a035/avatar.jpg 1.5x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/74d54/avatar.jpg 2x"}}]}}}}},{"node":{"fields":{"slug":"/blog/2018-07-29--misc/"},"timeToRead":4,"frontmatter":{"title":"Misc","updatedDate":"2019-10-23","image":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/98bc53d2012296d56b37cad2ff328b5a/37089/cup-of-coffee-laptop-office-macbook-89786.jpg","srcSet":"/static/98bc53d2012296d56b37cad2ff328b5a/37089/cup-of-coffee-laptop-office-macbook-89786.jpg 1x,\n/static/98bc53d2012296d56b37cad2ff328b5a/4a855/cup-of-coffee-laptop-office-macbook-89786.jpg 1.5x,\n/static/98bc53d2012296d56b37cad2ff328b5a/92aae/cup-of-coffee-laptop-office-macbook-89786.jpg 2x"}}]},"author":{"avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg","srcSet":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg 1x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/1a035/avatar.jpg 1.5x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/74d54/avatar.jpg 2x"}}]}}}}},{"node":{"fields":{"slug":"/blog/2019-10-08--ShadowSocks的种种/"},"timeToRead":7,"frontmatter":{"title":"ShadowSocks的种种","updatedDate":"2019-10-08","image":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/1ce0d1cd7e1d0637a29faca7d03ee87a/37089/shadowsocks.jpg","srcSet":"/static/1ce0d1cd7e1d0637a29faca7d03ee87a/37089/shadowsocks.jpg 1x,\n/static/1ce0d1cd7e1d0637a29faca7d03ee87a/4a855/shadowsocks.jpg 1.5x,\n/static/1ce0d1cd7e1d0637a29faca7d03ee87a/92aae/shadowsocks.jpg 2x"}}]},"author":{"avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg","srcSet":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg 1x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/1a035/avatar.jpg 1.5x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/74d54/avatar.jpg 2x"}}]}}}}},{"node":{"fields":{"slug":"/blog/2019-07-03--前端面试汇总/"},"timeToRead":28,"frontmatter":{"title":"前端面试汇总(持续更新)","updatedDate":"2019-07-28","image":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/509f7cfdd1a14bf357f75a03cde10624/37089/fe.jpg","srcSet":"/static/509f7cfdd1a14bf357f75a03cde10624/37089/fe.jpg 1x,\n/static/509f7cfdd1a14bf357f75a03cde10624/4a855/fe.jpg 1.5x,\n/static/509f7cfdd1a14bf357f75a03cde10624/92aae/fe.jpg 2x"}}]},"author":{"avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg","srcSet":"/static/d7657fc7ec759cfa220ac058ed0b571a/29d9a/avatar.jpg 1x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/1a035/avatar.jpg 1.5x,\n/static/d7657fc7ec759cfa220ac058ed0b571a/74d54/avatar.jpg 2x"}}]}}}}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2019-10-16--使用阿里云OSS+Docker搭建Nextcloud/"}}}